services:
  mariadb-master1:
    image: mariadb:11.4
    container_name: mariadb-master1
    entrypoint: ["/tmp/entrypoint-wrapper.sh"]
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: testdb
      MYSQL_REPL_USER: ${MYSQL_REPL_USER}
      MYSQL_REPL_PASSWORD: ${MYSQL_REPL_PASSWORD}
      MONITOR_USER: ${MONITOR_USER}
      MONITOR_PASSWORD: ${MONITOR_PASSWORD}
    volumes:
      - ./master1/data:/var/lib/mysql
      - ./scripts/entrypoint-wrapper.sh:/tmp/entrypoint-wrapper.sh:ro
      - ./scripts/init-users.sql:/tmp/init-template.sql:ro
    networks:
      - mariadb-cluster
    command: >
      --bind-address=0.0.0.0
      --server-id=1
      --log-bin=mysql-bin
      --binlog-format=ROW
      --relay-log=mysqld-relay-bin
      --relay-log-index=mysqld-relay-bin.index
      --max_connections=500
      --innodb_buffer_pool_size=3G
      --innodb_log_file_size=1G
      --innodb_log_buffer_size=256M
      --innodb_flush_log_at_trx_commit=0
      --innodb_flush_method=O_DIRECT
      --innodb_use_native_aio=OFF

      --innodb_io_capacity=4000
      --innodb_io_capacity_max=8000
      --innodb_read_io_threads=16
      --innodb_write_io_threads=16
      --innodb_doublewrite=OFF
      --innodb_flush_neighbors=0
      --innodb_adaptive_hash_index=ON

      --table_open_cache=8000
      --table_definition_cache=4000
      --query_cache_type=0
      --query_cache_size=0
      --tmp_table_size=512M
      --max_heap_table_size=512M
      --thread_cache_size=200
      --back_log=900
      --skip-name-resolve
      --skip-host-cache
      --connect_timeout=3
      --sort_buffer_size=8M
      --read_buffer_size=4M
      --read_rnd_buffer_size=8M
      --join_buffer_size=8M
      --bulk_insert_buffer_size=64M
      --key_buffer_size=256M
      --max_allowed_packet=1G
      --net_buffer_length=16K
      --binlog_cache_size=4M
      --sync_binlog=0

  mariadb-master2:
    image: mariadb:11.4
    container_name: mariadb-master2
    entrypoint: ["/tmp/entrypoint-wrapper.sh"]
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: testdb
      MYSQL_REPL_USER: ${MYSQL_REPL_USER}
      MYSQL_REPL_PASSWORD: ${MYSQL_REPL_PASSWORD}
      MONITOR_USER: ${MONITOR_USER}
      MONITOR_PASSWORD: ${MONITOR_PASSWORD}
      REPLICATION_MASTER: mariadb-master1
    volumes:
      - ./master2/data:/var/lib/mysql
      - ./scripts/entrypoint-wrapper.sh:/tmp/entrypoint-wrapper.sh:ro
      - ./scripts/init-users.sql:/tmp/init-template.sql:ro
      - ./scripts/setup-replication.sh:/docker-entrypoint-initdb.d/99-setup-replication.sh:ro
    networks:
      - mariadb-cluster
    command: >
      --bind-address=0.0.0.0
      --server-id=2
      --log-bin=mysql-bin
      --binlog-format=ROW
      --relay-log=mysqld-relay-bin
      --relay-log-index=mysqld-relay-bin.index
      --max_connections=500
      --innodb_buffer_pool_size=3G
      --innodb_log_file_size=1G
      --innodb_log_buffer_size=256M
      --innodb_flush_log_at_trx_commit=0
      --innodb_flush_method=O_DIRECT
      --innodb_use_native_aio=OFF

      --innodb_io_capacity=4000
      --innodb_io_capacity_max=8000
      --innodb_read_io_threads=16
      --innodb_write_io_threads=16
      --innodb_doublewrite=OFF
      --innodb_flush_neighbors=0
      --innodb_adaptive_hash_index=ON

      --table_open_cache=8000
      --table_definition_cache=4000
      --query_cache_type=0
      --query_cache_size=0
      --tmp_table_size=512M
      --max_heap_table_size=512M
      --thread_cache_size=200
      --back_log=900
      --skip-name-resolve
      --skip-host-cache
      --connect_timeout=3
      --sort_buffer_size=8M
      --read_buffer_size=4M
      --read_rnd_buffer_size=8M
      --join_buffer_size=8M
      --bulk_insert_buffer_size=64M
      --key_buffer_size=256M
      --max_allowed_packet=1G
      --net_buffer_length=16K
      --binlog_cache_size=4M
      --sync_binlog=0
    depends_on:
      - mariadb-master1

  mariadb-slave1:
    image: mariadb:11.4
    container_name: mariadb-slave1
    entrypoint: ["/tmp/entrypoint-wrapper.sh"]
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: testdb
      MYSQL_REPL_USER: ${MYSQL_REPL_USER}
      MYSQL_REPL_PASSWORD: ${MYSQL_REPL_PASSWORD}
      MONITOR_USER: ${MONITOR_USER}
      MONITOR_PASSWORD: ${MONITOR_PASSWORD}
      REPLICATION_MASTER: mariadb-master1
    volumes:
      - ./slave1/data:/var/lib/mysql
      - ./scripts/entrypoint-wrapper.sh:/tmp/entrypoint-wrapper.sh:ro
      - ./scripts/init-users.sql:/tmp/init-template.sql:ro
      - ./scripts/setup-replication.sh:/docker-entrypoint-initdb.d/99-setup-replication.sh:ro
    networks:
      - mariadb-cluster
    command: >
      --bind-address=0.0.0.0
      --server-id=3
      --log-bin=mysql-bin
      --binlog-format=ROW
      --read-only=ON
      --relay-log=mysqld-relay-bin
      --relay-log-index=mysqld-relay-bin.index
      --max_connections=500
      --innodb_buffer_pool_size=3G
      --innodb_log_file_size=1G
      --innodb_log_buffer_size=256M
      --innodb_flush_log_at_trx_commit=0
      --innodb_flush_method=O_DIRECT
      --innodb_use_native_aio=OFF

      --innodb_io_capacity=4000
      --innodb_io_capacity_max=8000
      --innodb_read_io_threads=16
      --innodb_write_io_threads=16
      --innodb_doublewrite=OFF
      --innodb_flush_neighbors=0
      --innodb_adaptive_hash_index=ON

      --table_open_cache=8000
      --table_definition_cache=4000
      --query_cache_type=0
      --query_cache_size=0
      --tmp_table_size=512M
      --max_heap_table_size=512M
      --thread_cache_size=200
      --back_log=900
      --skip-name-resolve
      --skip-host-cache
      --connect_timeout=3
      --sort_buffer_size=8M
      --read_buffer_size=4M
      --read_rnd_buffer_size=8M
      --join_buffer_size=8M
      --bulk_insert_buffer_size=64M
      --key_buffer_size=256M
      --max_allowed_packet=1G
      --net_buffer_length=16K
      --binlog_cache_size=4M
      --sync_binlog=0
      --slave_parallel_threads=8
    depends_on:
      - mariadb-master1
      - mariadb-master2

  mariadb-slave2:
    image: mariadb:11.4
    container_name: mariadb-slave2
    entrypoint: ["/tmp/entrypoint-wrapper.sh"]
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: testdb
      MYSQL_REPL_USER: ${MYSQL_REPL_USER}
      MYSQL_REPL_PASSWORD: ${MYSQL_REPL_PASSWORD}
      MONITOR_USER: ${MONITOR_USER}
      MONITOR_PASSWORD: ${MONITOR_PASSWORD}
      REPLICATION_MASTER: mariadb-master1
    volumes:
      - ./slave2/data:/var/lib/mysql
      - ./scripts/entrypoint-wrapper.sh:/tmp/entrypoint-wrapper.sh:ro
      - ./scripts/init-users.sql:/tmp/init-template.sql:ro
      - ./scripts/setup-replication.sh:/docker-entrypoint-initdb.d/99-setup-replication.sh:ro
    networks:
      - mariadb-cluster
    command: >
      --bind-address=0.0.0.0
      --server-id=4
      --log-bin=mysql-bin
      --binlog-format=ROW
      --read-only=ON
      --relay-log=mysqld-relay-bin
      --relay-log-index=mysqld-relay-bin.index
      --max_connections=500
      --innodb_buffer_pool_size=3G
      --innodb_log_file_size=1G
      --innodb_log_buffer_size=256M
      --innodb_flush_log_at_trx_commit=0
      --innodb_flush_method=O_DIRECT
      --innodb_use_native_aio=OFF

      --innodb_io_capacity=4000
      --innodb_io_capacity_max=8000
      --innodb_read_io_threads=16
      --innodb_write_io_threads=16
      --innodb_doublewrite=OFF
      --innodb_flush_neighbors=0
      --innodb_adaptive_hash_index=ON

      --table_open_cache=8000
      --table_definition_cache=4000
      --query_cache_type=0
      --query_cache_size=0
      --tmp_table_size=512M
      --max_heap_table_size=512M
      --thread_cache_size=200
      --back_log=900
      --skip-name-resolve
      --skip-host-cache
      --connect_timeout=3
      --sort_buffer_size=8M
      --read_buffer_size=4M
      --read_rnd_buffer_size=8M
      --join_buffer_size=8M
      --bulk_insert_buffer_size=64M
      --key_buffer_size=256M
      --max_allowed_packet=1G
      --net_buffer_length=16K
      --binlog_cache_size=4M
      --sync_binlog=0
      --slave_parallel_threads=8
    depends_on:
      - mariadb-master1
      - mariadb-master2

  mariadb-slave3:
    image: mariadb:11.4
    container_name: mariadb-slave3
    entrypoint: ["/tmp/entrypoint-wrapper.sh"]
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: testdb
      MYSQL_REPL_USER: ${MYSQL_REPL_USER}
      MYSQL_REPL_PASSWORD: ${MYSQL_REPL_PASSWORD}
      MONITOR_USER: ${MONITOR_USER}
      MONITOR_PASSWORD: ${MONITOR_PASSWORD}
      REPLICATION_MASTER: mariadb-master1
    volumes:
      - ./slave3/data:/var/lib/mysql
      - ./scripts/entrypoint-wrapper.sh:/tmp/entrypoint-wrapper.sh:ro
      - ./scripts/init-users.sql:/tmp/init-template.sql:ro
      - ./scripts/setup-replication.sh:/docker-entrypoint-initdb.d/99-setup-replication.sh:ro
    networks:
      - mariadb-cluster
    command: >
      --bind-address=0.0.0.0
      --server-id=5
      --log-bin=mysql-bin
      --binlog-format=ROW
      --read-only=ON
      --relay-log=mysqld-relay-bin
      --relay-log-index=mysqld-relay-bin.index
      --max_connections=500
      --innodb_buffer_pool_size=3G
      --innodb_log_file_size=1G
      --innodb_log_buffer_size=256M
      --innodb_flush_log_at_trx_commit=0
      --innodb_flush_method=O_DIRECT
      --innodb_use_native_aio=OFF

      --innodb_io_capacity=4000
      --innodb_io_capacity_max=8000
      --innodb_read_io_threads=16
      --innodb_write_io_threads=16
      --innodb_doublewrite=OFF
      --innodb_flush_neighbors=0
      --innodb_adaptive_hash_index=ON

      --table_open_cache=8000
      --table_definition_cache=4000
      --query_cache_type=0
      --query_cache_size=0
      --tmp_table_size=512M
      --max_heap_table_size=512M
      --thread_cache_size=200
      --back_log=900
      --skip-name-resolve
      --skip-host-cache
      --connect_timeout=3
      --sort_buffer_size=8M
      --read_buffer_size=4M
      --read_rnd_buffer_size=8M
      --join_buffer_size=8M
      --bulk_insert_buffer_size=64M
      --key_buffer_size=256M
      --max_allowed_packet=1G
      --net_buffer_length=16K
      --binlog_cache_size=4M
      --sync_binlog=0
      --slave_parallel_threads=8
    depends_on:
      - mariadb-master1
      - mariadb-master2

  mariadb-slave4:
    image: mariadb:11.4
    container_name: mariadb-slave4
    entrypoint: ["/tmp/entrypoint-wrapper.sh"]
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: testdb
      MYSQL_REPL_USER: ${MYSQL_REPL_USER}
      MYSQL_REPL_PASSWORD: ${MYSQL_REPL_PASSWORD}
      MONITOR_USER: ${MONITOR_USER}
      MONITOR_PASSWORD: ${MONITOR_PASSWORD}
      REPLICATION_MASTER: mariadb-master1
    volumes:
      - ./slave4/data:/var/lib/mysql
      - ./scripts/entrypoint-wrapper.sh:/tmp/entrypoint-wrapper.sh:ro
      - ./scripts/init-users.sql:/tmp/init-template.sql:ro
      - ./scripts/setup-replication.sh:/docker-entrypoint-initdb.d/99-setup-replication.sh:ro
    networks:
      - mariadb-cluster
    command: >
      --bind-address=0.0.0.0
      --server-id=6
      --log-bin=mysql-bin
      --binlog-format=ROW
      --read-only=ON
      --relay-log=mysqld-relay-bin
      --relay-log-index=mysqld-relay-bin.index
      --max_connections=500
      --innodb_buffer_pool_size=3G
      --innodb_log_file_size=1G
      --innodb_log_buffer_size=256M
      --innodb_flush_log_at_trx_commit=0
      --innodb_flush_method=O_DIRECT
      --innodb_use_native_aio=OFF

      --innodb_io_capacity=4000
      --innodb_io_capacity_max=8000
      --innodb_read_io_threads=16
      --innodb_write_io_threads=16
      --innodb_doublewrite=OFF
      --innodb_flush_neighbors=0
      --innodb_adaptive_hash_index=ON

      --table_open_cache=8000
      --table_definition_cache=4000
      --query_cache_type=0
      --query_cache_size=0
      --tmp_table_size=512M
      --max_heap_table_size=512M
      --thread_cache_size=200
      --back_log=900
      --skip-name-resolve
      --skip-host-cache
      --connect_timeout=3
      --sort_buffer_size=8M
      --read_buffer_size=4M
      --read_rnd_buffer_size=8M
      --join_buffer_size=8M
      --bulk_insert_buffer_size=64M
      --key_buffer_size=256M
      --max_allowed_packet=1G
      --net_buffer_length=16K
      --binlog_cache_size=4M
      --sync_binlog=0
      --slave_parallel_threads=8
    depends_on:
      - mariadb-master1
      - mariadb-master2

  proxysql:
    image: proxysql/proxysql:latest
    container_name: proxysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_REPL_USER: ${MYSQL_REPL_USER}
      MYSQL_REPL_PASSWORD: ${MYSQL_REPL_PASSWORD}
      MONITOR_USER: ${MONITOR_USER}
      MONITOR_PASSWORD: ${MONITOR_PASSWORD}
    volumes:
      - ./proxysql/generate-config.sh:/generate-config.sh
    ports:
      - "6033:6033"
      - "127.0.0.1:6032:6032"
    networks:
      - mariadb-cluster
    command: sh /generate-config.sh
    depends_on:
      - mariadb-master1
      - mariadb-master2
      - mariadb-slave1
      - mariadb-slave2
      - mariadb-slave3
      - mariadb-slave4

networks:
  mariadb-cluster:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
          gateway: 172.25.0.1
    internal: false  # Set to true untuk isolasi penuh (tidak bisa akses internet)


