services:
  mariadb-master1:
    image: mariadb:11.4
    container_name: mariadb-master1
    entrypoint: ["/bin/bash", "/tmp/entrypoint-wrapper.sh"]
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: testdb
      MYSQL_REPL_USER: ${MYSQL_REPL_USER}
      MYSQL_REPL_PASSWORD: ${MYSQL_REPL_PASSWORD}
      MONITOR_USER: ${MONITOR_USER}
      MONITOR_PASSWORD: ${MONITOR_PASSWORD}
    volumes:
      - ./master1/data:/var/lib/mysql
      - ./scripts/entrypoint-wrapper.sh:/tmp/entrypoint-wrapper.sh:ro
      - ./scripts/init-users.sql:/tmp/init-template.sql:ro
    networks:
      mariadb-cluster:
        ipv4_address: 172.25.0.10
    deploy:
      resources:
        limits:
          cpus: '6'
          memory: 6G
        reservations:
          cpus: '4'
          memory: 4G
    command: >
      --bind-address=0.0.0.0
      --server-id=1
      --log-bin=mysql-bin
      --binlog-format=ROW
      --relay-log=mysqld-relay-bin
      --relay-log-index=mysqld-relay-bin.index

      --max_connections=1500
      --thread_cache_size=200
      --back_log=1000
      --thread_handling=pool-of-threads
      --thread_pool_size=12
      --thread_pool_max_threads=2000

      --innodb_buffer_pool_size=3G
      --innodb_log_file_size=1G
      --innodb_log_buffer_size=256M
      --innodb_flush_log_at_trx_commit=2
      --innodb_flush_method=O_DIRECT
      innodb_use_native_aio=ON

      --innodb_io_capacity=2000
      --innodb_io_capacity_max=4000
      --innodb_read_io_threads=4
      --innodb_write_io_threads=8
      --innodb_doublewrite=ON
      --innodb_flush_neighbors=0
      --innodb_adaptive_hash_index=ON

      --table_open_cache=4000
      --table_definition_cache=2000
      --tmp_table_size=512M
      --max_heap_table_size=512M
      --skip-name-resolve
      --skip-host-cache
      --connect_timeout=10
      --wait_timeout=300
      --interactive_timeout=300
      --sort_buffer_size=4M
      --read_buffer_size=2M
      --read_rnd_buffer_size=4M
      --join_buffer_size=4M
      --bulk_insert_buffer_size=32M
      --key_buffer_size=128M
      --max_allowed_packet=256M
      --net_buffer_length=16K
      --binlog_cache_size=4M
      --sync_binlog=1
      --slave_parallel_threads=8
      --slave_parallel_mode=optimistic
      --slave_parallel_max_queued=8M
      --auto_increment_increment=2
      --auto_increment_offset=1
      --gtid_strict_mode=ON
      --log_slave_updates=ON

  mariadb-master2:
    image: mariadb:11.4
    container_name: mariadb-master2
    entrypoint: ["/bin/bash", "/tmp/entrypoint-wrapper.sh"]
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: testdb
      MYSQL_REPL_USER: ${MYSQL_REPL_USER}
      MYSQL_REPL_PASSWORD: ${MYSQL_REPL_PASSWORD}
      MONITOR_USER: ${MONITOR_USER}
      MONITOR_PASSWORD: ${MONITOR_PASSWORD}
      REPLICATION_MASTER: mariadb-master1
    volumes:
      - ./master2/data:/var/lib/mysql
      - ./scripts/entrypoint-wrapper.sh:/tmp/entrypoint-wrapper.sh:ro
      - ./scripts/init-users.sql:/tmp/init-template.sql:ro
      - ./scripts/setup-replication.sh:/docker-entrypoint-initdb.d/99-setup-replication.sh:ro
    networks:
      mariadb-cluster:
        ipv4_address: 172.25.0.11
    deploy:
      resources:
        limits:
          cpus: '6'
          memory: 6G
        reservations:
          cpus: '4'
          memory: 4G
    command: >
      --bind-address=0.0.0.0
      --server-id=2
      --log-bin=mysql-bin
      --binlog-format=ROW
      --relay-log=mysqld-relay-bin
      --relay-log-index=mysqld-relay-bin.index

      --max_connections=1500
      --thread_cache_size=200
      --back_log=1000
      --thread_handling=pool-of-threads
      --thread_pool_size=12
      --thread_pool_max_threads=2000

      --innodb_buffer_pool_size=3G
      --innodb_log_file_size=1G
      --innodb_log_buffer_size=256M
      --innodb_flush_log_at_trx_commit=2
      --innodb_flush_method=O_DIRECT
      innodb_use_native_aio=ON

      --innodb_io_capacity=2000
      --innodb_io_capacity_max=4000
      --innodb_read_io_threads=4
      --innodb_write_io_threads=8
      --innodb_doublewrite=ON
      --innodb_flush_neighbors=0
      --innodb_adaptive_hash_index=ON

      --table_open_cache=4000
      --table_definition_cache=2000
      --tmp_table_size=512M
      --max_heap_table_size=512M
      --skip-name-resolve
      --skip-host-cache
      --connect_timeout=10
      --wait_timeout=300
      --interactive_timeout=300
      --sort_buffer_size=4M
      --read_buffer_size=2M
      --read_rnd_buffer_size=4M
      --join_buffer_size=4M
      --bulk_insert_buffer_size=32M
      --key_buffer_size=128M
      --max_allowed_packet=256M
      --net_buffer_length=16K
      --binlog_cache_size=4M
      --sync_binlog=1
      --slave_parallel_threads=8
      --slave_parallel_mode=optimistic
      --slave_parallel_max_queued=8M
      --auto_increment_increment=2
      --auto_increment_offset=2
      --gtid_strict_mode=ON
      --log_slave_updates=ON
    depends_on:
      - mariadb-master1

  mariadb-slave1:
    image: mariadb:11.4
    container_name: mariadb-slave1
    entrypoint: ["/bin/bash", "/tmp/entrypoint-wrapper.sh"]
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: testdb
      MYSQL_REPL_USER: ${MYSQL_REPL_USER}
      MYSQL_REPL_PASSWORD: ${MYSQL_REPL_PASSWORD}
      MONITOR_USER: ${MONITOR_USER}
      MONITOR_PASSWORD: ${MONITOR_PASSWORD}
      REPLICATION_MASTER: mariadb-master1
    volumes:
      - ./slave1/data:/var/lib/mysql
      - ./scripts/entrypoint-wrapper.sh:/tmp/entrypoint-wrapper.sh:ro
      - ./scripts/init-users.sql:/tmp/init-template.sql:ro
      - ./scripts/setup-replication.sh:/docker-entrypoint-initdb.d/99-setup-replication.sh:ro
    networks:
      mariadb-cluster:
        ipv4_address: 172.25.0.20
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1.5G
    command: >
      --bind-address=0.0.0.0
      --server-id=3
      --log-bin=mysql-bin
      --binlog-format=ROW
      --read-only=ON
      --relay-log=mysqld-relay-bin
      --relay-log-index=mysqld-relay-bin.index

      --max_connections=800
      --thread_cache_size=150
      --back_log=500
      --thread_handling=pool-of-threads
      --thread_pool_size=8

      --innodb_buffer_pool_size=1200M
      --innodb_log_file_size=256M
      --innodb_log_buffer_size=64M
      --innodb_flush_log_at_trx_commit=2
      --innodb_flush_method=O_DIRECT
      innodb_use_native_aio=ON

      --innodb_io_capacity=1500
      --innodb_io_capacity_max=3000
      --innodb_read_io_threads=8
      --innodb_write_io_threads=2
      --innodb_doublewrite=OFF
      --innodb_flush_neighbors=0
      --innodb_adaptive_hash_index=ON

      --table_open_cache=3000
      --table_definition_cache=1500
      --tmp_table_size=256M
      --max_heap_table_size=256M
      --skip-name-resolve
      --skip-host-cache
      --connect_timeout=10
      --wait_timeout=300
      --sort_buffer_size=4M
      --read_buffer_size=4M
      --read_rnd_buffer_size=8M
      --join_buffer_size=4M
      --bulk_insert_buffer_size=16M
      --key_buffer_size=64M
      --max_allowed_packet=256M
      --net_buffer_length=16K
      --binlog_cache_size=1M
      --sync_binlog=0
      --slave_parallel_threads=8
      --slave_parallel_mode=optimistic
      --slave_parallel_max_queued=8M
    depends_on:
      - mariadb-master1

  mariadb-slave2:
    image: mariadb:11.4
    container_name: mariadb-slave2
    entrypoint: ["/bin/bash", "/tmp/entrypoint-wrapper.sh"]
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: testdb
      MYSQL_REPL_USER: ${MYSQL_REPL_USER}
      MYSQL_REPL_PASSWORD: ${MYSQL_REPL_PASSWORD}
      MONITOR_USER: ${MONITOR_USER}
      MONITOR_PASSWORD: ${MONITOR_PASSWORD}
      REPLICATION_MASTER: mariadb-master1
    volumes:
      - ./slave2/data:/var/lib/mysql
      - ./scripts/entrypoint-wrapper.sh:/tmp/entrypoint-wrapper.sh:ro
      - ./scripts/init-users.sql:/tmp/init-template.sql:ro
      - ./scripts/setup-replication.sh:/docker-entrypoint-initdb.d/99-setup-replication.sh:ro
    networks:
      mariadb-cluster:
        ipv4_address: 172.25.0.21
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1.5G
    command: >
      --bind-address=0.0.0.0
      --server-id=4
      --log-bin=mysql-bin
      --binlog-format=ROW
      --read-only=ON
      --relay-log=mysqld-relay-bin
      --relay-log-index=mysqld-relay-bin.index

      --max_connections=800
      --thread_cache_size=150
      --back_log=500
      --thread_handling=pool-of-threads
      --thread_pool_size=8

      --innodb_buffer_pool_size=1200M
      --innodb_log_file_size=256M
      --innodb_log_buffer_size=64M
      --innodb_flush_log_at_trx_commit=2
      --innodb_flush_method=O_DIRECT
      innodb_use_native_aio=ON

      --innodb_io_capacity=1500
      --innodb_io_capacity_max=3000
      --innodb_read_io_threads=8
      --innodb_write_io_threads=2
      --innodb_doublewrite=OFF
      --innodb_flush_neighbors=0
      --innodb_adaptive_hash_index=ON

      --table_open_cache=3000
      --table_definition_cache=1500
      --tmp_table_size=256M
      --max_heap_table_size=256M
      --skip-name-resolve
      --skip-host-cache
      --connect_timeout=10
      --wait_timeout=300
      --sort_buffer_size=4M
      --read_buffer_size=4M
      --read_rnd_buffer_size=8M
      --join_buffer_size=4M
      --bulk_insert_buffer_size=16M
      --key_buffer_size=64M
      --max_allowed_packet=256M
      --net_buffer_length=16K
      --binlog_cache_size=1M
      --sync_binlog=0
      --slave_parallel_threads=8
      --slave_parallel_mode=optimistic
      --slave_parallel_max_queued=8M
    depends_on:
      - mariadb-master1

  mariadb-slave3:
    image: mariadb:11.4
    container_name: mariadb-slave3
    entrypoint: ["/bin/bash", "/tmp/entrypoint-wrapper.sh"]
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: testdb
      MYSQL_REPL_USER: ${MYSQL_REPL_USER}
      MYSQL_REPL_PASSWORD: ${MYSQL_REPL_PASSWORD}
      MONITOR_USER: ${MONITOR_USER}
      MONITOR_PASSWORD: ${MONITOR_PASSWORD}
      REPLICATION_MASTER: mariadb-master1
    volumes:
      - ./slave3/data:/var/lib/mysql
      - ./scripts/entrypoint-wrapper.sh:/tmp/entrypoint-wrapper.sh:ro
      - ./scripts/init-users.sql:/tmp/init-template.sql:ro
      - ./scripts/setup-replication.sh:/docker-entrypoint-initdb.d/99-setup-replication.sh:ro
    networks:
      mariadb-cluster:
        ipv4_address: 172.25.0.22
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1.5G
    command: >
      --bind-address=0.0.0.0
      --server-id=5
      --log-bin=mysql-bin
      --binlog-format=ROW
      --read-only=ON
      --relay-log=mysqld-relay-bin
      --relay-log-index=mysqld-relay-bin.index

      --max_connections=800
      --thread_cache_size=150
      --back_log=500
      --thread_handling=pool-of-threads
      --thread_pool_size=8

      --innodb_buffer_pool_size=1200M
      --innodb_log_file_size=256M
      --innodb_log_buffer_size=64M
      --innodb_flush_log_at_trx_commit=2
      --innodb_flush_method=O_DIRECT
      innodb_use_native_aio=ON

      --innodb_io_capacity=1500
      --innodb_io_capacity_max=3000
      --innodb_read_io_threads=8
      --innodb_write_io_threads=2
      --innodb_doublewrite=OFF
      --innodb_flush_neighbors=0
      --innodb_adaptive_hash_index=ON

      --table_open_cache=3000
      --table_definition_cache=1500
      --tmp_table_size=256M
      --max_heap_table_size=256M
      --skip-name-resolve
      --skip-host-cache
      --connect_timeout=10
      --wait_timeout=300
      --sort_buffer_size=4M
      --read_buffer_size=4M
      --read_rnd_buffer_size=8M
      --join_buffer_size=4M
      --bulk_insert_buffer_size=16M
      --key_buffer_size=64M
      --max_allowed_packet=256M
      --net_buffer_length=16K
      --binlog_cache_size=1M
      --sync_binlog=0
      --slave_parallel_threads=8
      --slave_parallel_mode=optimistic
      --slave_parallel_max_queued=8M
    depends_on:
      - mariadb-master1

  mariadb-slave4:
    image: mariadb:11.4
    container_name: mariadb-slave4
    entrypoint: ["/bin/bash", "/tmp/entrypoint-wrapper.sh"]
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: testdb
      MYSQL_REPL_USER: ${MYSQL_REPL_USER}
      MYSQL_REPL_PASSWORD: ${MYSQL_REPL_PASSWORD}
      MONITOR_USER: ${MONITOR_USER}
      MONITOR_PASSWORD: ${MONITOR_PASSWORD}
      REPLICATION_MASTER: mariadb-master1
    volumes:
      - ./slave4/data:/var/lib/mysql
      - ./scripts/entrypoint-wrapper.sh:/tmp/entrypoint-wrapper.sh:ro
      - ./scripts/init-users.sql:/tmp/init-template.sql:ro
      - ./scripts/setup-replication.sh:/docker-entrypoint-initdb.d/99-setup-replication.sh:ro
    networks:
      mariadb-cluster:
        ipv4_address: 172.25.0.23
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1.5G
    command: >
      --bind-address=0.0.0.0
      --server-id=6
      --log-bin=mysql-bin
      --binlog-format=ROW
      --read-only=ON
      --relay-log=mysqld-relay-bin
      --relay-log-index=mysqld-relay-bin.index

      --max_connections=800
      --thread_cache_size=150
      --back_log=500
      --thread_handling=pool-of-threads
      --thread_pool_size=8

      --innodb_buffer_pool_size=1200M
      --innodb_log_file_size=256M
      --innodb_log_buffer_size=64M
      --innodb_flush_log_at_trx_commit=2
      --innodb_flush_method=O_DIRECT
      innodb_use_native_aio=ON

      --innodb_io_capacity=1500
      --innodb_io_capacity_max=3000
      --innodb_read_io_threads=8
      --innodb_write_io_threads=2
      --innodb_doublewrite=OFF
      --innodb_flush_neighbors=0
      --innodb_adaptive_hash_index=ON

      --table_open_cache=3000
      --table_definition_cache=1500
      --tmp_table_size=256M
      --max_heap_table_size=256M
      --skip-name-resolve
      --skip-host-cache
      --connect_timeout=10
      --wait_timeout=300
      --sort_buffer_size=4M
      --read_buffer_size=4M
      --read_rnd_buffer_size=8M
      --join_buffer_size=4M
      --bulk_insert_buffer_size=16M
      --key_buffer_size=64M
      --max_allowed_packet=256M
      --net_buffer_length=16K
      --binlog_cache_size=1M
      --sync_binlog=0
      --slave_parallel_threads=8
      --slave_parallel_mode=optimistic
      --slave_parallel_max_queued=8M
    depends_on:
      - mariadb-master1

  proxysql:
    image: proxysql/proxysql:latest
    container_name: proxysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_REPL_USER: ${MYSQL_REPL_USER}
      MYSQL_REPL_PASSWORD: ${MYSQL_REPL_PASSWORD}
      MONITOR_USER: ${MONITOR_USER}
      MONITOR_PASSWORD: ${MONITOR_PASSWORD}
    volumes:
      - ./proxysql/generate-config.sh:/generate-config.sh
    ports:
      - "6033:6033"
      - "127.0.0.1:6032:6032"
    networks:
      mariadb-cluster:
        ipv4_address: 172.25.0.100
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
    command: sh /generate-config.sh
    depends_on:
      - mariadb-master1
      - mariadb-master2
      - mariadb-slave1
      - mariadb-slave2
      - mariadb-slave3
      - mariadb-slave4

networks:
  mariadb-cluster:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
          gateway: 172.25.0.1
    driver_opts:
      com.docker.network.driver.mtu: 1500
    internal: false
